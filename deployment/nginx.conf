# VerifyAI Nginx Configuration
# Location: /etc/nginx/sites-available/verifyai

server {
    listen 80;
    listen [::]:80;

    # 由 Cloudflare Tunnel 轉發，不需要對外開放
    # 所以只監聽 localhost
    server_name localhost 127.0.0.1;

    # 文件根目錄
    root /var/www/verifyai;

    # 預設首頁
    index verifyai-complete-final_4.html index.html;

    # 訪問日誌
    access_log /var/log/nginx/verifyai_access.log;
    error_log /var/log/nginx/verifyai_error.log;

    # 字符集
    charset utf-8;

    # ============================================
    # 主要路由配置
    # ============================================

    location / {
        # 嘗試訪問檔案，找不到則返回 404
        try_files $uri $uri/ =404;

        # 預設顯示 landing page
        index verifyai-complete-final_4.html;
    }

    # 處理根路徑
    location = / {
        try_files /verifyai-complete-final_4.html =404;
    }

    # ============================================
    # 靜態資源快取配置
    # ============================================

    # JavaScript 和 CSS 檔案 - 快取 1 天
    location ~* \.(js|css)$ {
        expires 1d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 圖片檔案 - 快取 7 天
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 字型檔案 - 快取 30 天
    location ~* \.(woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ============================================
    # 安全性設定
    # ============================================

    # 隱藏 Nginx 版本號
    server_tokens off;

    # 安全標頭
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # 禁止訪問隱藏檔案
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止訪問 Git 檔案
    location ~ /\.git {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止訪問部署配置檔案
    location ~ ^/deployment/ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ============================================
    # Gzip 壓縮
    # ============================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        application/atom+xml
        image/svg+xml;

    # ============================================
    # 錯誤頁面
    # ============================================

    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
    }

    # ============================================
    # 健康檢查端點（用於監控）
    # ============================================

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# ============================================
# 如果未來需要支援 HTTPS（本地測試用）
# ============================================
#
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#
#     server_name localhost;
#
#     # SSL 憑證（自簽證書）
#     ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
#     ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
#
#     # SSL 設定
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_prefer_server_ciphers on;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#
#     # 其他設定同上
#     root /var/www/verifyai;
#     index verifyai-complete-final_4.html;
#
#     location / {
#         try_files $uri $uri/ =404;
#     }
# }
